<!DOCTYPE html>
<html>
<head>
  <!--
    Tämä sovellus käyttää Google OAuth 2.0 -autentikointia client-side-koodissa.
    CLIENT_ID näkyy lähdekoodissa, mikä on täysin hyväksyttävää ja turvallista.

    Miksi tämä ei ole tietoturvariski?
    - Client ID on julkinen tunniste, ei salainen avain.
    - Käyttäjän kirjautuminen ja luvananto vaaditaan aina.
    - Sovellus pyytää vain rajatun "drive.file" -oikeuden (voi käsitellä vain itse luomiaan tiedostoja).
    - Älä koskaan sisällytä client_secret-arvoja client-side-koodiin.
  -->
  <meta charset="UTF-8">
  <title>Ampumapäiväkirja</title>
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body { font-family: sans-serif; padding: 2em; max-width: 600px; margin: auto; }
    input, textarea, button { width: 100%; margin-bottom: 1em; padding: 0.5em; }
  </style>
</head>
<body>
  <h1>Ampumapäiväkirja</h1>
  <div id="login"></div>
  <form id="log-form" style="display:none">
    <input type="date" id="date" required>
    <input type="text" id="location" placeholder="Rata / paikka" required>
    <input type="text" id="weapon" placeholder="Ase / kaliiperi" required>
    <input type="number" id="rounds" placeholder="Laukaukset" required>
    <textarea id="notes" placeholder="Huomiot / fiilikset"></textarea>
    <button type="submit">Tallenna Driveen</button>
  </form>
  <div id="status"></div>

  <script>
    const CLIENT_ID = '131369731464-onbrnu5hlf96r06bn2nhuas9fk1r2mmb.apps.googleusercontent.com';
    const SCOPES = 'https://www.googleapis.com/auth/drive.file';

    let tokenClient;
    let accessToken = null;

    function initGoogleAuth() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: (tokenResponse) => {
          if (tokenResponse.access_token) {
            accessToken = tokenResponse.access_token;
            document.getElementById('log-form').style.display = 'block';
            document.getElementById('login').innerHTML = '<p>Kirjautunut.</p>';
          }
        },
      });

      const loginBtn = document.createElement('button');
      loginBtn.textContent = 'Kirjaudu Google-tilillä';
      loginBtn.onclick = () => tokenClient.requestAccessToken();
      document.getElementById('login').appendChild(loginBtn);
    }

    async function uploadLog(data) {
      const metadata = {
        name: 'ampumapaivakirja.json',
        mimeType: 'application/json'
      };

      const boundary = '-------314159265358979323846';
      const delimiter = `\r\n--${boundary}\r\n`;
      const close_delim = `\r\n--${boundary}--`;

      const multipartRequestBody =
        delimiter +
        'Content-Type: application/json\r\n\r\n' +
        JSON.stringify(metadata) +
        delimiter +
        'Content-Type: application/json\r\n\r\n' +
        JSON.stringify(data) +
        close_delim;

      const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
        method: 'POST',
        headers: new Headers({
          'Authorization': 'Bearer ' + accessToken,
          'Content-Type': 'multipart/related; boundary=' + boundary
        }),
        body: multipartRequestBody
      });

      const result = await response.json();
      document.getElementById('status').textContent = 'Tallennettu tiedostoon: ' + result.name;
    }

    document.getElementById('log-form').addEventListener('submit', (e) => {
      e.preventDefault();
      const log = {
        date: document.getElementById('date').value,
        location: document.getElementById('location').value,
        weapon: document.getElementById('weapon').value,
        rounds: document.getElementById('rounds').value,
        notes: document.getElementById('notes').value
      };
      uploadLog(log);
    });

    window.onload = initGoogleAuth;
  </script>
</body>
</html>
