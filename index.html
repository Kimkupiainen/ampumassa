<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8">
  <title>Ampumapäiväkirja (Sheets)</title>
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <h1>Ampumapäiväkirja</h1>
  <div id="login"></div>

  <form id="log-form" style="display:none">
    <input type="date" id="date" required>
    <input type="text" id="location" placeholder="Rata / paikka" required>
    <input type="text" id="weapon" placeholder="Ase / kaliiperi" required>
    <input type="number" id="rounds" placeholder="Laukaukset" required>
    <textarea id="notes" placeholder="Huomiot / fiilikset"></textarea>
    <button type="submit">Tallenna Sheettiin</button>
  </form>

  <button id="toggle-dark" style="display:none">Vaihda teema</button>
  <button id="load-entries" style="display:none">Näytä aiemmat merkinnät</button>
  <div id="status"></div>
  <div id="entries"></div>

  <script>
    const CLIENT_ID = '131369731464-onbrnu5hlf96r06bn2nhuas9fk1r2mmb.apps.googleusercontent.com';
    const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';
    const SHEET_NAME = 'ampumapaivakirja';

    let accessToken = null;
    let spreadsheetId = null;

    function initGoogleAuth() {
      google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: async (tokenResponse) => {
          if (tokenResponse.access_token) {
            accessToken = tokenResponse.access_token;
            document.getElementById('log-form').style.display = 'block';
            document.getElementById('toggle-dark').style.display = 'inline-block';
            document.getElementById('load-entries').style.display = 'inline-block';
            document.getElementById('login').innerHTML = '<p>Kirjautunut.</p>';
            await findOrCreateSheet();
          }
        }
      }).requestAccessToken();
    }

    async function findOrCreateSheet() {
      const query = `name='${SHEET_NAME}' and mimeType='application/vnd.google-apps.spreadsheet' and trashed=false`;
      const res = await fetch(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}&fields=files(id,name)`, {
        headers: { Authorization: 'Bearer ' + accessToken }
      });
      const data = await res.json();
      if (data.files && data.files.length > 0) {
        spreadsheetId = data.files[0].id;
      } else {
			const createRes = await fetch('https://sheets.googleapis.com/v4/spreadsheets', {
			  method: 'POST',
			  headers: {
				Authorization: 'Bearer ' + accessToken,
				'Content-Type': 'application/json'
			  },
			  body: JSON.stringify({
				properties: { title: SHEET_NAME },
				sheets: [{
				  properties: { title: 'Merkinnät' },
				  data: [{
					startRow: 0,
					startColumn: 0,
					rowData: [{
					  values: [
						{ userEnteredValue: { stringValue: 'Päivämäärä' } },
						{ userEnteredValue: { stringValue: 'Paikka' } },
						{ userEnteredValue: { stringValue: 'Ase' } },
						{ userEnteredValue: { stringValue: 'Laukaukset' } },
						{ userEnteredValue: { stringValue: 'Huomiot' } }
					  ]
					}]
				  }]
				}]
			  })
			});
        const sheet = await createRes.json();
        spreadsheetId = sheet.spreadsheetId;
      }
    }

    async function uploadToSheet(entry) {
      const values = [[entry.date, entry.location, entry.weapon, entry.rounds, entry.notes]];
      await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/Merkinnät!A1:append?valueInputOption=USER_ENTERED`, {
        method: 'POST',
        headers: {
          Authorization: 'Bearer ' + accessToken,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ values })
      });

      document.getElementById('status').textContent = 'Tallennettu taulukkoon!';
    }

    async function loadEntriesFromSheet() {
      const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/Merkinnät`, {
        headers: { Authorization: 'Bearer ' + accessToken }
      });
      const data = await res.json();
      const rows = data.values || [];
      const container = document.getElementById('entries');
      container.innerHTML = '<h2>Merkinnät</h2>';
      if (rows.length <= 1) {
        container.innerHTML += '<p>Ei aiempia merkintöjä.</p>';
        return;
      }
      rows.slice(1).reverse().forEach(row => {
        const [date, location, weapon, rounds, notes] = row;
        const el = document.createElement('div');
        el.style.borderBottom = '1px solid #ccc';
        el.style.padding = '0.5em 0';
        el.innerHTML = `
          <strong>${date}</strong> – ${location}<br>
          ${weapon}, ${rounds} laukausta<br>
          <em>${notes || 'Ei merkintöjä'}</em>
        `;
        container.appendChild(el);
      });
    }

    document.getElementById('log-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const log = {
        date: document.getElementById('date').value,
        location: document.getElementById('location').value,
        weapon: document.getElementById('weapon').value,
        rounds: document.getElementById('rounds').value,
        notes: document.getElementById('notes').value
      };
      await uploadToSheet(log);
    });

    document.getElementById('load-entries').addEventListener('click', loadEntriesFromSheet);
    document.getElementById('toggle-dark').addEventListener('click', () => {
      document.body.classList.toggle('dark-mode');
    });

    window.onload = () => {
      const loginBtn = document.createElement('button');
      loginBtn.textContent = 'Kirjaudu Google-tilillä';
      loginBtn.onclick = initGoogleAuth;
      document.getElementById('login').appendChild(loginBtn);
    };
  </script>
</body>
</html>
