<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8">
  <title>AmpumapÃ¤ivÃ¤kirja</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <h1>AmpumapÃ¤ivÃ¤kirja</h1>
  <button onclick="toggleDarkMode()">ğŸŒ“ Vaihda teema</button>

  <div id="login">
    <button id="login-btn">Kirjaudu Google-tilillÃ¤</button>
  </div>

  <form id="log-form" style="display:none">
    <input type="date" id="date" required>
    <input type="text" id="event" placeholder="Tapahtuma" required>
    <input type="text" id="weapon" placeholder="Ase / kaliiperi" required>
    <select id="tt" required>
      <option value="">Valitse toimintatapa</option>
      <option value="TT1">TT1 â€“ kertatuli ilman lipasta</option>
      <option value="TT2">TT2 â€“ kertatuli lippaalla</option>
      <option value="TT3">TT3 â€“ itselataava kertatuli</option>
      <option value="TT4">TT4 â€“ sarjatuli</option>
    </select>
    <input type="text" id="location" placeholder="Paikka" required>
    <input type="number" id="rounds" placeholder="Laukaukset" required>
    <textarea id="notes" placeholder="Kuvaus / huomiot"></textarea>
    <button class="save" type="submit">Tallenna merkintÃ¤</button>
  </form>

  <div>
    <button id="load-entries" style="display:none">ğŸ“– NÃ¤ytÃ¤ merkinnÃ¤t</button>
    <div id="status"></div>
    <div id="entries"></div>
  </div>

  <script>
    const CLIENT_ID = '131369731464-onbrnu5hlf96r06bn2nhuas9fk1r2mmb.apps.googleusercontent.com';
    const SCOPES = 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.metadata.readonly';
    const SHEET_NAME = 'ampumapaivakirja';
    const SHEET_TAB = 'MerkinnÃ¤t';
    let accessToken = null;
    let spreadsheetId = null;
    let editingRow = null;
    let tokenClient;

    function toggleDarkMode() {
      document.body.classList.toggle('dark');
    }

    async function getSheetIdByTitle(title) {
      const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}`, {
        headers: { Authorization: 'Bearer ' + accessToken }
      });
      const data = await res.json();
      const sheet = data.sheets.find(s => s.properties.title === title);
      return sheet?.properties?.sheetId;
    }

    async function findOrCreateSheet() {
      const driveQuery = `name='${SHEET_NAME}' and mimeType='application/vnd.google-apps.spreadsheet' and trashed=false`;
      const driveRes = await fetch(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(driveQuery)}&fields=files(id,name)`, {
        headers: { Authorization: 'Bearer ' + accessToken }
      });
      const driveData = await driveRes.json();

      if (driveData.files && driveData.files.length > 0) {
        spreadsheetId = driveData.files[0].id;
        return;
      }

      const createRes = await fetch('https://sheets.googleapis.com/v4/spreadsheets', {
        method: 'POST',
        headers: {
          Authorization: 'Bearer ' + accessToken,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          properties: { title: SHEET_NAME },
          sheets: [{
            properties: { title: SHEET_TAB },
            data: [{
              startRow: 0,
              startColumn: 0,
              rowData: [{
                values: [
                  { userEnteredValue: { stringValue: 'PÃ¤ivÃ¤mÃ¤Ã¤rÃ¤' } },
                  { userEnteredValue: { stringValue: 'Tapahtuma' } },
                  { userEnteredValue: { stringValue: 'Ase' } },
                  { userEnteredValue: { stringValue: 'Toimintatapa' } },
                  { userEnteredValue: { stringValue: 'Paikka' } },
                  { userEnteredValue: { stringValue: 'Laukaukset' } },
                  { userEnteredValue: { stringValue: 'Kuvaus' } }
                ]
              }]
            }]
          }]
        })
      });
      const json = await createRes.json();
      spreadsheetId = json.spreadsheetId;
    }

    document.getElementById('log-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const row = [
        document.getElementById('date').value,
        document.getElementById('event').value,
        document.getElementById('weapon').value,
        document.getElementById('tt').value,
        document.getElementById('location').value,
        document.getElementById('rounds').value,
        document.getElementById('notes').value
      ];

      const range = `${SHEET_TAB}!A${editingRow + 1}`;
      const method = editingRow ? 'PUT' : 'POST';
      const url = editingRow
        ? `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${range}?valueInputOption=RAW`
        : `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${SHEET_TAB}!A1:append?valueInputOption=RAW`;

      await fetch(url, {
        method,
        headers: { Authorization: 'Bearer ' + accessToken, 'Content-Type': 'application/json' },
        body: JSON.stringify(editingRow ? { range, values: [row] } : { values: [row] })
      });

      editingRow = null;
      document.getElementById('log-form').reset();
      setStatus('MerkintÃ¤ tallennettu.', true);
    });

    document.getElementById('load-entries').onclick = async () => {
      const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${SHEET_TAB}`, {
        headers: { Authorization: 'Bearer ' + accessToken }
      });
      const data = await res.json();
      const rows = data.values.slice(1);
      const container = document.getElementById('entries');

      if (window.innerWidth >= 600) {
        container.innerHTML = `<table><thead><tr><th>PÃ¤ivÃ¤mÃ¤Ã¤rÃ¤</th><th>Tapahtuma</th><th>Ase</th><th>TT</th><th>Paikka</th><th>Laukaukset</th><th>Kuvaus</th><th>Toiminnot</th></tr></thead><tbody>
        ${rows.map((r, i) => `<tr>
          ${r.map(cell => `<td>${cell}</td>`).join('')}
          <td class="actions">
            <button class="edit" onclick="editRow(${i + 1})">Muokkaa</button>
            <button class="delete" onclick="deleteRow(${i + 1})">Poista</button>
          </td>
        </tr>`).join('')}</tbody></table>`;
      } else {
        container.innerHTML = rows.map((r, i) => `
          <div class="entry-card">
            <h3>${r[0] || ''} â€“ ${r[1] || ''}</h3>
            <p><strong>Ase:</strong> ${r[2] || ''} (${r[3] || ''})</p>
            <p><strong>Paikka:</strong> ${r[4] || ''}</p>
            <p><strong>Laukaukset:</strong> ${r[5] || ''}</p>
            <p><strong>Kuvaus:</strong><br>${r[6] || ''}</p>
            <div class="actions">
              <button class="edit" onclick="editRow(${i + 1})">Muokkaa</button>
              <button class="delete" onclick="deleteRow(${i + 1})">Poista</button>
            </div>
          </div>`).join('');
      }
    };

    function setStatus(msg, success = true) {
      const status = document.getElementById('status');
      status.textContent = msg;
      status.className = success ? 'success' : 'error';
    }

    window.editRow = async (index) => {
      const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${SHEET_TAB}!A${index + 1}`, {
        headers: { Authorization: 'Bearer ' + accessToken }
      });
      const data = await res.json();
      const v = data.values[0];
      ['date', 'event', 'weapon', 'tt', 'location', 'rounds', 'notes'].forEach((id, i) => {
        document.getElementById(id).value = v[i] || '';
      });
      editingRow = index;
      window.scrollTo(0, 0);
    };

    window.deleteRow = async (index) => {
      const sheetId = await getSheetIdByTitle(SHEET_TAB);
      const request = {
        requests: [{
          deleteDimension: {
            range: { sheetId, dimension: 'ROWS', startIndex: index, endIndex: index + 1 }
          }
        }]
      };
      await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}:batchUpdate`, {
        method: 'POST',
        headers: { Authorization: 'Bearer ' + accessToken, 'Content-Type': 'application/json' },
        body: JSON.stringify(request)
      });
      setStatus('Rivi poistettu.', true);
      document.getElementById('load-entries').click();
    };

    window.onload = () => {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: async (response) => {
          if (!response.access_token) {
            setStatus('Kirjautuminen epÃ¤onnistui.', false);
            return;
          }
          accessToken = response.access_token;
          document.getElementById('log-form').style.display = 'block';
          document.getElementById('load-entries').style.display = 'inline';
          document.getElementById('login').innerHTML = '<p>Kirjautunut.</p>';
          await findOrCreateSheet();
        }
      });

      document.getElementById('login-btn').onclick = () => {
        tokenClient.requestAccessToken();
      };
    };
  </script>
</body>
</html>
