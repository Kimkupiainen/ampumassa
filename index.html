
<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8">
  <title>AmpumapÃ¤ivÃ¤kirja</title>
  <script src="https://accounts.google.com/gsi/client" async defer>
document.getElementById('export-pdf').onclick = async () => {
  const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${SHEET_TAB}`, {
    headers: { Authorization: 'Bearer ' + accessToken }
  });
  const data = await res.json();
  const rows = data.values;

  const doc = new jsPDF();
  doc.setFontSize(14);
  doc.text("AmpumapÃ¤ivÃ¤kirja", 10, 10);

  let y = 20;
  rows.forEach((r, i) => {
    const line = r.join(" | ");
    doc.text(line, 10, y);
    y += 8;
    if (y > 280) {
      doc.addPage();
      y = 10;
    }
  });

  doc.save("ampumapaivakirja.pdf");
};


document.getElementById('export-pdf').onclick = async () => {
  const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${SHEET_TAB}`, {
    headers: { Authorization: 'Bearer ' + accessToken }
  });
  const data = await res.json();
  const rows = data.values;

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(14);
  doc.text("AmpumapÃ¤ivÃ¤kirja", 10, 10);

  let y = 20;
  rows.forEach((r, i) => {
    const line = r.join(" | ");
    doc.text(line, 10, y);
    y += 8;
    if (y > 280) {
      doc.addPage();
      y = 10;
    }
  });

  doc.save("ampumapaivakirja.pdf");
};

</script>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js">
document.getElementById('export-pdf').onclick = async () => {
  const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${SHEET_TAB}`, {
    headers: { Authorization: 'Bearer ' + accessToken }
  });
  const data = await res.json();
  const rows = data.values;

  const doc = new jsPDF();
  doc.setFontSize(14);
  doc.text("AmpumapÃ¤ivÃ¤kirja", 10, 10);

  let y = 20;
  rows.forEach((r, i) => {
    const line = r.join(" | ");
    doc.text(line, 10, y);
    y += 8;
    if (y > 280) {
      doc.addPage();
      y = 10;
    }
  });

  doc.save("ampumapaivakirja.pdf");
};


document.getElementById('export-pdf').onclick = async () => {
  const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${SHEET_TAB}`, {
    headers: { Authorization: 'Bearer ' + accessToken }
  });
  const data = await res.json();
  const rows = data.values;

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(14);
  doc.text("AmpumapÃ¤ivÃ¤kirja", 10, 10);

  let y = 20;
  rows.forEach((r, i) => {
    const line = r.join(" | ");
    doc.text(line, 10, y);
    y += 8;
    if (y > 280) {
      doc.addPage();
      y = 10;
    }
  });

  doc.save("ampumapaivakirja.pdf");
};

</script>
</head>
<body>
  <h1>AmpumapÃ¤ivÃ¤kirja</h1>
  <button onclick="toggleDarkMode()">ðŸŒ“ Vaihda teema</button>
  <div id="login"><button id="login-btn">Kirjaudu Google-tilillÃ¤</button></div>

  <form id="log-form" style="display:none">
    <input type="date" id="date" required>
    <input type="text" id="event" placeholder="Tapahtuma" required>
    <input type="text" id="weapon" placeholder="Ase / kaliiperi" required>
    <select id="tt" required>
      <option value="">Valitse toimintatapa</option>
      <option value="TT1">TT1 â€“ kertatuli ilman lipasta</option>
      <option value="TT2">TT2 â€“ kertatuli lippaalla</option>
      <option value="TT3">TT3 â€“ itselataava kertatuli</option>
      <option value="TT4">TT4 â€“ sarjatuli</option>
    </select>
    <input type="text" id="location" placeholder="Paikka" required>
    <input type="number" id="rounds" placeholder="Laukaukset" required>
    <textarea id="notes" placeholder="Kuvaus / huomiot"></textarea>
    <div>
      <button type="submit" class="save">Tallenna merkintÃ¤</button>
      <button type="button" onclick="cancelEdit()">Peru muokkaus</button>
    </div>
  </form>

  <div id="status"></div>
  <div style="margin: 1em 0;">
    <button id="load-entries" style="display:none">ðŸ“‹ NÃ¤ytÃ¤ merkinnÃ¤t</button>
    <button id="export-pdf" style="display:none">ðŸ“„ Lataa PDF</button>
  </div>
  <div id="entries"></div>

  <script>
    const CLIENT_ID = '131369731464-onbrnu5hlf96r06bn2nhuas9fk1r2mmb.apps.googleusercontent.com';
    const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';
    const SHEET_NAME = 'ampumapaivakirja';
    const SHEET_TAB = 'MerkinnÃ¤t';
    let accessToken = null;
    let spreadsheetId = null;
    let editingRow = null;
    let tokenClient;

    function toggleDarkMode() {
      document.body.classList.toggle('dark');
    }

    function cancelEdit() {
      document.getElementById('log-form').reset();
      editingRow = null;
      document.getElementById('status').textContent = 'Muokkaus peruttu.';
    }

    async function getSheetIdByTitle(title) {
      const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}`, {
        headers: { Authorization: 'Bearer ' + accessToken }
      });
      const data = await res.json();
      const sheet = data.sheets.find(s => s.properties.title === title);
      return sheet?.properties?.sheetId;
    }

    async function findOrCreateSheet() {
      const query = `name='${SHEET_NAME}' and mimeType='application/vnd.google-apps.spreadsheet' and trashed=false`;
      const driveRes = await fetch(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}&fields=files(id,name)`, {
        headers: { Authorization: 'Bearer ' + accessToken }
      });
      const data = await driveRes.json();

      if (data.files?.length) {
        spreadsheetId = data.files[0].id;
        return;
      }

      const createRes = await fetch('https://sheets.googleapis.com/v4/spreadsheets', {
        method: 'POST',
        headers: {
          Authorization: 'Bearer ' + accessToken,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          properties: { title: SHEET_NAME },
          sheets: [{
            properties: { title: SHEET_TAB },
            data: [{
              startRow: 0,
              startColumn: 0,
              rowData: [{
                values: [
                  { userEnteredValue: { stringValue: 'PÃ¤ivÃ¤mÃ¤Ã¤rÃ¤' } },
                  { userEnteredValue: { stringValue: 'Tapahtuma' } },
                  { userEnteredValue: { stringValue: 'Ase' } },
                  { userEnteredValue: { stringValue: 'Toimintatapa' } },
                  { userEnteredValue: { stringValue: 'Paikka' } },
                  { userEnteredValue: { stringValue: 'Laukaukset' } },
                  { userEnteredValue: { stringValue: 'Kuvaus' } }
                ]
              }]
            }]
          }]
        })
      });
      const json = await createRes.json();
      spreadsheetId = json.spreadsheetId;
    }

    window.onload = () => {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: async (response) => {
          if (!response.access_token) return;
          accessToken = response.access_token;
          document.getElementById('log-form').style.display = 'block';
          document.getElementById('load-entries').style.display = 'inline';
          document.getElementById('export-pdf').style.display = 'inline';
          document.getElementById('login').innerHTML = '<p>Kirjautunut.</p>';
          await findOrCreateSheet();
        }
      });

      document.getElementById('login-btn').onclick = () => {
        tokenClient.requestAccessToken();
      };

      document.getElementById('log-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const row = [
          document.getElementById('date').value,
          document.getElementById('event').value,
          document.getElementById('weapon').value,
          document.getElementById('tt').value,
          document.getElementById('location').value,
          document.getElementById('rounds').value,
          document.getElementById('notes').value
        ];
        if (editingRow) {
          const range = `${SHEET_TAB}!A${editingRow + 1}`;
          await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${range}?valueInputOption=RAW`, {
            method: 'PUT',
            headers: { Authorization: 'Bearer ' + accessToken, 'Content-Type': 'application/json' },
            body: JSON.stringify({ range, values: [row] })
          });
          editingRow = null;
        } else {
          await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${SHEET_TAB}!A1:append?valueInputOption=RAW`, {
            method: 'POST',
            headers: { Authorization: 'Bearer ' + accessToken, 'Content-Type': 'application/json' },
            body: JSON.stringify({ values: [row] })
          });
        }
        document.getElementById('log-form').reset();
        document.getElementById('status').textContent = 'MerkintÃ¤ tallennettu.';
      });

      document.getElementById('load-entries').onclick = async () => {
        const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${SHEET_TAB}`, {
          headers: { Authorization: 'Bearer ' + accessToken }
        });
        const data = await res.json();
        const rows = data.values.slice(1);
        const container = document.getElementById('entries');
        container.innerHTML = rows.map((r, i) => `
          <div class="entry-card">
            <h3>${r[0] || ''} â€“ ${r[1] || ''}</h3>
            <p><strong>Ase:</strong> ${r[2] || ''} (${r[3] || ''})</p>
            <p><strong>Paikka:</strong> ${r[4] || ''}</p>
            <p><strong>Laukaukset:</strong> ${r[5] || ''}</p>
            <p><strong>Kuvaus:</strong><br>${r[6] || ''}</p>
            <div class="actions">
              <button class="edit" onclick="editRow(${i + 1})">Muokkaa</button>
              <button class="delete" onclick="deleteRow(${i + 1})">Poista</button>
            </div>
          </div>
        `).join('');
      };

      window.editRow = async (index) => {
        const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${SHEET_TAB}!A${index + 1}`, {
          headers: { Authorization: 'Bearer ' + accessToken }
        });
        const data = await res.json();
        const v = data.values[0];
        ['date', 'event', 'weapon', 'tt', 'location', 'rounds', 'notes'].forEach((id, i) => {
          document.getElementById(id).value = v[i] || '';
        });
        editingRow = index;
        document.getElementById('status').textContent = `Muokataan riviÃ¤ ${index}`;
        window.scrollTo(0, 0);
      };

      window.deleteRow = async (index) => {
        const sheetId = await getSheetIdByTitle(SHEET_TAB);
        if (!sheetId) {
          document.getElementById('status').textContent = 'Taulukkoa ei lÃ¶ytynyt.';
          return;
        }
        const request = {
          requests: [{
            deleteDimension: {
              range: {
                sheetId: sheetId,
                dimension: 'ROWS',
                startIndex: index,
                endIndex: index + 1
              }
            }
          }]
        };
        await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}:batchUpdate`, {
          method: 'POST',
          headers: {
            Authorization: 'Bearer ' + accessToken,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(request)
        });
        document.getElementById('status').textContent = 'Rivi poistettu.';
        document.getElementById('load-entries').click();
      };
    };
  
document.getElementById('export-pdf').onclick = async () => {
  const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${SHEET_TAB}`, {
    headers: { Authorization: 'Bearer ' + accessToken }
  });
  const data = await res.json();
  const rows = data.values;

  const doc = new jsPDF();
  doc.setFontSize(14);
  doc.text("AmpumapÃ¤ivÃ¤kirja", 10, 10);

  let y = 20;
  rows.forEach((r, i) => {
    const line = r.join(" | ");
    doc.text(line, 10, y);
    y += 8;
    if (y > 280) {
      doc.addPage();
      y = 10;
    }
  });

  doc.save("ampumapaivakirja.pdf");
};


document.getElementById('export-pdf').onclick = async () => {
  const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${SHEET_TAB}`, {
    headers: { Authorization: 'Bearer ' + accessToken }
  });
  const data = await res.json();
  const rows = data.values;

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(10);
  doc.text("AmpumapÃ¤ivÃ¤kirja", 10, 10);

  let y = 20;
  rows.forEach((r, i) => {
    const line = r.join(" | ");
    doc.text(line, 10, y);
    y += 8;
    if (y > 280) {
      doc.addPage();
      y = 10;
    }
  });

  doc.save("ampumapaivakirja.pdf");
};

</script>
</body>
</html>
