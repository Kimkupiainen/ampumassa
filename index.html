
<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ampumap√§iv√§kirja</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js">
</script>
</head>
<body class="dark">
<div>
<header class="site-header">
  <div class="nav-container">
    <div class="brand">AMPUMASSA<button class="menu-toggle" aria-label="Valikko">‚ò∞</button></div>
    <nav class="nav-links">
      <a href="index.html" class="active">Etusivu</a>
      <a href="tietosuojaseloste.html">Tietosuoja</a>
    </nav>
  </div>
</header>
</div>
<main>
  <h1><strong>AMPUMASSA</strong><br> Ampumap√§iv√§kirja netiss√§</h1>
  
  <div id="login"><button id="login-btn">Kirjaudu Google-tilill√§</button></div>
<div id="intro">
  <p>
    <strong>AMPUMASSA</strong> on henkil√∂kohtainen ty√∂kalu ammuntojen seurantaan.
    Kirjaa yl√∂s p√§iv√§m√§√§r√§, ase, laukausm√§√§r√§t, paikka ja vapaamuotoiset huomiot jokaiselta ampumakerralta.
  </p>
  <p>
    Tiedot tallennetaan omaan Google Driveesi, ja niit√§ voi tarkastella sek√§ PDF-muodossa ett√§ selaimessa.
    Sovellus toimii my√∂s mobiililaitteilla, ja oppii automaattisesti aiemmin k√§ytetyt aseet ja paikat. Tietojasi ei ker√§t√§ sivuston hallinnoijan toimesta eik√§ luovuteta koskaan kolmansille osapuolille tarpeettomasti.
  </p>
</div>
  <form id="log-form" style="display:none">
    <input type="date" id="date" required>
    <input type="text" id="event" placeholder="Tapahtuma" required>
	<input list="weapons" id="weapon" placeholder="Ase / kaliiperi" required>
	<datalist id="weapons"></datalist>
    <select id="tt" required>
      <option value="">Valitse toimintatapa</option>
      <option value="TT1">TT1 ‚Äì kertatuli ilman lipasta</option>
      <option value="TT2">TT2 ‚Äì kertatuli lippaalla</option>
      <option value="TT3">TT3 ‚Äì itselataava kertatuli</option>
      <option value="TT4">TT4 ‚Äì sarjatuli</option>
    </select>
	<input list="locations" id="location" placeholder="Paikka" required>
	<datalist id="locations"></datalist>
    <input type="number" id="rounds" placeholder="Laukaukset" required>
    <textarea id="notes" placeholder="Kuvaus / huomiot"></textarea>
    <div>
      <button type="submit" class="save">Tallenna merkint√§</button>
      <button type="button" onclick="cancelEdit()">Peru muokkaus</button>
    </div>
	  <div id="status"></div>
  </form>


	<div id="entries">
	  <div>
		<button id="load-entries" style="display:none">üìã N√§yt√§ merkinn√§t</button>
		<button id="export-pdf" style="display:none">üìÑ Lataa PDF</button>
	  </div>
	  <div id="entry-cards"></div> <!-- <- t√§m√§ lis√§ttiin -->
	</div>
	  <!-- Loader -->
	<div id="loader" style="display: none;">
	  <div class="spinner"></div>
	</div>

	<!-- Popup confirmation -->
	<div id="confirmation-popup" style="display: none;">
	  <div class="popup-content">
		<h3>Merkint√§ lis√§tty</h3>
		<div id="popup-details"></div>
		<button onclick="closeConfirmation()">OK</button>
	  </div>
	</div>
  <script>
    const CLIENT_ID = '131369731464-onbrnu5hlf96r06bn2nhuas9fk1r2mmb.apps.googleusercontent.com';
    const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';
    const SHEET_NAME = 'ampumapaivakirja';
    const SHEET_TAB = 'Merkinn√§t';
    let accessToken = null;
    let spreadsheetId = null;
    let editingRow = null;
    let tokenClient;

    function toggleDarkMode() {
      document.body.classList.toggle('dark');
    }

    function saveToLocalStorage(key, value) {
	  if (!value) return;
	  let existing = JSON.parse(localStorage.getItem(key) || "[]");

	  // Normalize existing for comparison only
	  const normalized = existing.map(v => v.trim().toLowerCase());
	  const candidate = value.trim().toLowerCase();

	  if (!normalized.includes(candidate)) {
		existing.push(value.trim()); // keep original casing for UX
		localStorage.setItem(key, JSON.stringify(existing));
	  }
	}
	
	function populateDatalist(id, key) {
      const list = document.getElementById(id);
      const items = JSON.parse(localStorage.getItem(key) || "[]");
	  items.sort()
      list.innerHTML = '';
	items.forEach(val => {
	  const opt = document.createElement('option');
	  opt.value = val;
	  list.appendChild(opt);
	});
    }
	document.querySelector('.menu-toggle').onclick = () => {
  document.querySelector('.nav-links').classList.toggle('open');
};
    function cancelEdit() {
      document.getElementById('log-form').reset();
      editingRow = null;
      document.getElementById('status').textContent = 'Muokkaus peruttu.';
    }
	function escapeHTML(str) {
	  return str.replace(/[&<>"']/g, match => ({
		'&': '&amp;',
		'<': '&lt;',
		'>': '&gt;',
		'"': '&quot;',
		"'": '&#039;'
	  }[match]));
	}
		function showLoader() {
	  document.getElementById('loader').style.display = 'flex';
	}

	function hideLoader() {
	  document.getElementById('loader').style.display = 'none';
	}

	function showConfirmation(row) {
	  const details = `
		<p><strong>P√§iv√§m√§√§r√§:</strong> ${escapeHTML(row[0])}</p>
		<p><strong>Tapahtuma:</strong> ${escapeHTML(row[1])}</p>
		<p><strong>Ase:</strong> ${escapeHTML(row[2])} (${escapeHTML(row[3])})</p>
		<p><strong>Paikka:</strong> ${escapeHTML(row[4])}</p>
		<p><strong>Laukaukset:</strong> ${escapeHTML(row[5])}</p>
		<p><strong>Kuvaus:</strong> ${escapeHTML(row[6])}</p>
	  `;
	  document.getElementById('popup-details').innerHTML = details;
	  document.getElementById('confirmation-popup').style.display = 'flex';
	}

	function closeConfirmation() {
	  document.getElementById('confirmation-popup').style.display = 'none';
	}

    async function getSheetIdByTitle(title) {
      const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}`, {
        headers: { Authorization: 'Bearer ' + accessToken }
      });
      const data = await res.json();
      const sheet = data.sheets.find(s => s.properties.title === title);
      return sheet?.properties?.sheetId;
    }

    async function findOrCreateSheet() {
      const query = `name='${SHEET_NAME}' and mimeType='application/vnd.google-apps.spreadsheet' and trashed=false`;
      const driveRes = await fetch(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}&fields=files(id,name)`, {
        headers: { Authorization: 'Bearer ' + accessToken }
      });
      const data = await driveRes.json();

      if (data.files?.length) {
        spreadsheetId = data.files[0].id;
        return;
      }

      const createRes = await fetch('https://sheets.googleapis.com/v4/spreadsheets', {
        method: 'POST',
        headers: {
          Authorization: 'Bearer ' + accessToken,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          properties: { title: SHEET_NAME },
          sheets: [{
            properties: { title: SHEET_TAB },
            data: [{
              startRow: 0,
              startColumn: 0,
              rowData: [{
                values: [
                  { userEnteredValue: { stringValue: 'P√§iv√§m√§√§r√§' } },
                  { userEnteredValue: { stringValue: 'Tapahtuma' } },
                  { userEnteredValue: { stringValue: 'Ase' } },
                  { userEnteredValue: { stringValue: 'Toimintatapa' } },
                  { userEnteredValue: { stringValue: 'Paikka' } },
                  { userEnteredValue: { stringValue: 'Laukaukset' } },
                  { userEnteredValue: { stringValue: 'Kuvaus' } }
                ]
              }]
            }]
          }]
        })
      });
      const json = await createRes.json();
      spreadsheetId = json.spreadsheetId;
    }

    window.onload = () => {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: async (response) => {
          if (!response.access_token) return;
          accessToken = response.access_token;
          document.getElementById('log-form').style.display = 'block';
          document.getElementById('load-entries').style.display = 'inline';
          document.getElementById('export-pdf').style.display = 'inline';
          document.getElementById('login').innerHTML = '<p>Olet kirjautunut sis√§√§n</p>';
          await findOrCreateSheet();
		  populateDatalist("weapons", "weapons");
          populateDatalist("locations", "locations");
        }
      });

      document.getElementById('login-btn').onclick = () => {
        tokenClient.requestAccessToken();
      };

      document.getElementById('log-form').addEventListener('submit', async (e) => {
        showLoader();
		e.preventDefault();
        const row = [
          document.getElementById('date').value,
          document.getElementById('event').value,
          document.getElementById('weapon').value,
          document.getElementById('tt').value,
          document.getElementById('location').value,
          document.getElementById('rounds').value,
          document.getElementById('notes').value
        ];
		    saveToLocalStorage("weapons", document.getElementById('weapon').value);
			saveToLocalStorage("locations", document.getElementById('location').value);
        if (editingRow) {
          const range = `${SHEET_TAB}!A${editingRow + 1}`;
          await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${range}?valueInputOption=RAW`, {
            method: 'PUT',
            headers: { Authorization: 'Bearer ' + accessToken, 'Content-Type': 'application/json' },
            body: JSON.stringify({ range, values: [row] })
          });
          editingRow = null;
        } else {
          await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${SHEET_TAB}!A1:append?valueInputOption=RAW`, {
            method: 'POST',
            headers: { Authorization: 'Bearer ' + accessToken, 'Content-Type': 'application/json' },
            body: JSON.stringify({ values: [row] })
          });
        }
		hideLoader();
		showConfirmation(row);
        document.getElementById('log-form').reset();
        document.getElementById('status').textContent = 'Merkint√§ tallennettu.';
      });

		  window.loadEntries = async function () {
		  document.getElementById('global-loader').style.display = 'flex';
		  const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${SHEET_TAB}`, {
			headers: { Authorization: 'Bearer ' + accessToken }
		  });
		  const data = await res.json();
		  const rows = data.values.slice(1);
		  const totalRows = rows.length;
		  rows.reverse();

		  const container = document.getElementById('entry-cards'); // <- t√§m√§ on nyt uusi alue
		  container.innerHTML = '';

		  rows.forEach((r, i) => {
			const sheetRowIndex = totalRows - i;

			const card = document.createElement('div');
			card.className = 'entry-card';

			const title = document.createElement('h3');
			title.textContent = `${r[0] || ''} ‚Äì ${r[1] || ''}`;
			card.appendChild(title);

			const weapon = document.createElement('p');
			weapon.textContent = `Ase: ${r[2] || ''} (${r[3] || ''})`;
			card.appendChild(weapon);

			const location = document.createElement('p');
			location.textContent = `Paikka: ${r[4] || ''}`;
			card.appendChild(location);

			const rounds = document.createElement('p');
			rounds.textContent = `Laukaukset: ${r[5] || ''}`;
			card.appendChild(rounds);

			const notes = document.createElement('p');
			const label = document.createElement('strong');
			label.textContent = 'Kuvaus:';

			notes.appendChild(label);
			notes.appendChild(document.createElement('br'));
			notes.appendChild(document.createTextNode(r[6] || ''));
			card.appendChild(notes);

			const actions = document.createElement('div');
			actions.className = 'actions';

			const editBtn = document.createElement('button');
			editBtn.className = 'edit';
			editBtn.textContent = 'Muokkaa';
			editBtn.onclick = () => editRow(sheetRowIndex);
			actions.appendChild(editBtn);

			const deleteBtn = document.createElement('button');
			deleteBtn.className = 'delete';
			deleteBtn.textContent = 'Poista';
			deleteBtn.onclick = () => deleteRow(sheetRowIndex, card);
			actions.appendChild(deleteBtn);

			card.appendChild(actions);
			container.appendChild(card);
		  });
		  document.getElementById('global-loader').style.display = 'none';
		}

		document.getElementById('load-entries').onclick = loadEntries;
		}; 

      window.editRow = async (index) => {
        const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${SHEET_TAB}!A${index + 1}`, {
          headers: { Authorization: 'Bearer ' + accessToken }
        });
        const data = await res.json();
        const v = data.values[0];
        ['date', 'event', 'weapon', 'tt', 'location', 'rounds', 'notes'].forEach((id, i) => {
          document.getElementById(id).value = v[i] || '';
        });
        editingRow = index;
        document.getElementById('status').textContent = `Muokataan rivi√§ ${index}`;
        window.scrollTo(0, 0);
      };

		window.deleteRow = async function(index, cardElement) {
		  const sheetId = await getSheetIdByTitle(SHEET_TAB);
		  if (!sheetId) {
			document.getElementById('status').textContent = 'Taulukkoa ei l√∂ytynyt.';
			return;
		  }

		  // Harmaannuta kortti ja n√§yt√§ tila
		  cardElement.style.opacity = '0.5';
		  cardElement.querySelector('.actions').innerHTML = '<em>Poistetaan...</em>';

		  const request = {
			requests: [{
			  deleteDimension: {
				range: {
				  sheetId: sheetId,
				  dimension: 'ROWS',
				  startIndex: index,
				  endIndex: index + 1
				}
			  }
			}]
		  };

		  await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}:batchUpdate`, {
			method: 'POST',
			headers: {
			  Authorization: 'Bearer ' + accessToken,
			  'Content-Type': 'application/json'
			},
			body: JSON.stringify(request)
		  });

		  // Poista kortti n√§kyvist√§ heti
		  cardElement.remove();

		  document.getElementById('status').textContent = 'Rivi poistettu.';
		};
  
		document.getElementById('export-pdf').onclick = async () => {
		  const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${SHEET_TAB}`, {
			headers: { Authorization: 'Bearer ' + accessToken }
		  });
		  const data = await res.json();
		  const rows = data.values;

		  const { jsPDF } = window.jspdf;
		  const doc = new jsPDF();
		  const lineHeight = 5.5; 
		  let y = 20;

		  doc.setFontSize(16);
		  doc.text("Ampumap√§iv√§kirja", 10, 15);
		  doc.setFontSize(10);         // aiemmin 12
 

		  // skipataan header (rows[0])
		  for (let i = 1; i < rows.length; i++) {
			const [date, event, weapon, tt, location, rounds, notes = ""] = rows[i];

			const block = [
			  `${date} ‚Äî ${event}`,
			  `${weapon} (${tt}) @ ${location} | ${rounds} laukausta`,
			  `Huomiot: ${notes || "-"}`
			];

			for (let line of block) {
			  const split = doc.splitTextToSize(line, 180); // automaattinen rivinvaihto
			  doc.text(split, 10, y);
			  y += split.length * lineHeight;
			}

			y += 5; // v√§li merkint√∂jen v√§liin

			if (y > 270) {
			  doc.addPage();
			  y = 20;
			}
		  }

		  doc.save("ampumapaivakirja.pdf");
		};

</script>
</main>
<footer id="app-footer">
  ¬© 2025 Kim Kupiainen ‚Äì Kaikki oikeudet pid√§tet√§√§n.
<br><button class="donation-button" onclick="window.open('https://qr.mobilepay.fi/box/844a12a5-3cd7-46da-a256-1d6954215f5f/pay-in', '_blank')">
  ‚òï Droppaa kahvirahaa
</button>
</footer>
<div id="global-loader" style="display:none;">
  <div class="global-loader-content">
    <div class="spinner"></div>
    <p>Haetaan merkint√∂j√§...</p>
  </div>
</div>
</body>
</html>
