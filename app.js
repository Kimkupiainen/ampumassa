const CLIENT_ID="131369731464-onbrnu5hlf96r06bn2nhuas9fk1r2mmb.apps.googleusercontent.com",SCOPES="https://www.googleapis.com/auth/spreadsheets",SHEET_NAME="ampumapaivakirja",SHEET_TAB="Merkinnät";let tokenClient,accessToken=null,spreadsheetId=null,editingRow=null;function toggleDarkMode(){document.body.classList.toggle("dark")}function saveToLocalStorage(e,t){if(!t)return;let a=JSON.parse(localStorage.getItem(e)||"[]");const n=a.map((e=>e.trim().toLowerCase())),s=t.trim().toLowerCase();n.includes(s)||(a.push(t.trim()),localStorage.setItem(e,JSON.stringify(a)))}function populateDatalist(e,t){const a=document.getElementById(e),n=JSON.parse(localStorage.getItem(t)||"[]");n.sort(),a.innerHTML="",n.forEach((e=>{const t=document.createElement("option");t.value=e,a.appendChild(t)}))}function cancelEdit(){document.getElementById("log-form").reset(),editingRow=null,document.getElementById("status").textContent="Muokkaus peruttu."}function escapeHTML(e){return"string"!=typeof e&&(e=String(e)),e.replace(/[&<>"']/g,(e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[e])))}function showLoader(){document.getElementById("loader").style.display="flex"}function hideLoader(){document.getElementById("loader").style.display="none"}function showConfirmation(e){const t=`\n\t\t<p><strong>Päivämäärä:</strong> ${escapeHTML(e[0])}</p>\n\t\t<p><strong>Tapahtuma:</strong> ${escapeHTML(e[1])}</p>\n\t\t<p><strong>Asetyyppi:</strong> ${escapeHTML(e[2])}</p>\n\t\t<p><strong>Kaliiperi:</strong> ${escapeHTML(e[3])}</p>\n\t\t<p><strong>Ase:</strong> ${escapeHTML(e[4])} (${escapeHTML(e[5])})</p>\n\t\t<p><strong>Paikka:</strong> ${escapeHTML(e[6])}</p>\n\t\t<p><strong>Laukaukset:</strong> ${escapeHTML(e[7])}</p>\n\t\t<p><strong>Kuvaus:</strong> ${escapeHTML(e[8])}</p>\n\t  `;document.getElementById("popup-details").innerHTML=t,document.getElementById("confirmation-popup").style.display="flex"}function closeConfirmation(){document.getElementById("confirmation-popup").style.display="none"}async function getSheetIdByTitle(e){const t=await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}`,{headers:{Authorization:"Bearer "+accessToken}}),a=(await t.json()).sheets.find((t=>t.properties.title===e));return a?.properties?.sheetId}async function findOrCreateSheet(){const e=localStorage.getItem("ampuma_sheet_id");if(e)return spreadsheetId=e,console.log("Käytetään tallennettua spreadsheetId:tä:",spreadsheetId),await createRaporttiSheet(),void await applyDateFormatting();const t=`name='${SHEET_NAME}' and mimeType='application/vnd.google-apps.spreadsheet' and trashed=false`,a=await fetch(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(t)}&fields=files(id,name,createdTime,modifiedTime)`,{headers:{Authorization:"Bearer "+accessToken}}),n=await a.json();if(n.files?.length)return spreadsheetId=n.files[0].id,localStorage.setItem("ampuma_sheet_id",spreadsheetId),console.log("Käytetään olemassa olevaa tiedostoa:",spreadsheetId),await createRaporttiSheet(),void await applyDateFormatting();const s=await fetch("https://sheets.googleapis.com/v4/spreadsheets",{method:"POST",headers:{Authorization:"Bearer "+accessToken,"Content-Type":"application/json"},body:JSON.stringify({properties:{title:SHEET_NAME},sheets:[{properties:{title:SHEET_TAB},data:[{startRow:0,startColumn:0,rowData:[{values:[{userEnteredValue:{stringValue:"Päivämäärä"}},{userEnteredValue:{stringValue:"Tapahtuma"}},{userEnteredValue:{stringValue:"Asetyyppi"}},{userEnteredValue:{stringValue:"Kaliiperi"}},{userEnteredValue:{stringValue:"Ase"}},{userEnteredValue:{stringValue:"Toimintatapa"}},{userEnteredValue:{stringValue:"Paikka"}},{userEnteredValue:{stringValue:"Laukaukset"}},{userEnteredValue:{stringValue:"Kuvaus"}}]}]}]}]})}),o=await s.json();spreadsheetId=o.spreadsheetId,localStorage.setItem("ampuma_sheet_id",spreadsheetId),console.log("Luotiin uusi spreadsheetId:",spreadsheetId),await createRaporttiSheet(),await applyDateFormatting()}async function applyDateFormatting(){const e=await getSheetIdByTitle(SHEET_TAB);e&&await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}:batchUpdate`,{method:"POST",headers:{Authorization:"Bearer "+accessToken,"Content-Type":"application/json"},body:JSON.stringify({requests:[{repeatCell:{range:{sheetId:e,startColumnIndex:0,endColumnIndex:1},cell:{userEnteredFormat:{numberFormat:{type:"DATE",pattern:"yyyy-mm-dd"}}},fields:"userEnteredFormat.numberFormat"}}]})})}async function createRaporttiSheet(){const e=await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}`,{headers:{Authorization:"Bearer "+accessToken}});if((await e.json()).sheets.find((e=>"Raportti"===e.properties.title)))return void console.log("Raportti-välilehti on jo olemassa.");const t=await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}:batchUpdate`,{method:"POST",headers:{Authorization:"Bearer "+accessToken,"Content-Type":"application/json"},body:JSON.stringify({requests:[{addSheet:{properties:{title:"Raportti"}}}]})}),a=await t.json(),n=a.replies?.[0]?.addSheet?.properties?.sheetId;if(!n)return void console.error("Raportti-välilehden luonti epäonnistui.");const s=[{values:[{userEnteredValue:{stringValue:"Toimintatapa"}},{userEnteredValue:{stringValue:"1v Käynnit"}},{userEnteredValue:{stringValue:"1v Laukaukset"}},{userEnteredValue:{stringValue:"2v Käynnit"}},{userEnteredValue:{stringValue:"2v Laukaukset"}}]},...["TT1","TT2","TT3","TT4"].map((e=>({values:[{userEnteredValue:{stringValue:e}},{userEnteredValue:{formulaValue:`=COUNTIFS(Merkinnät!D:D, "${e}", Merkinnät!A:A, ">"&TODAY()-365)`}},{userEnteredValue:{formulaValue:`=SUMIFS(Merkinnät!F:F, Merkinnät!D:D, "${e}", Merkinnät!A:A, ">"&TODAY()-365)`}},{userEnteredValue:{formulaValue:`=COUNTIFS(Merkinnät!D:D, "${e}", Merkinnät!A:A, ">"&TODAY()-730)`}},{userEnteredValue:{formulaValue:`=SUMIFS(Merkinnät!F:F, Merkinnät!D:D, "${e}", Merkinnät!A:A, ">"&TODAY()-730)`}}]})))];await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}:batchUpdate`,{method:"POST",headers:{Authorization:"Bearer "+accessToken,"Content-Type":"application/json"},body:JSON.stringify({requests:[{updateCells:{rows:s,fields:"userEnteredValue",start:{sheetId:n,rowIndex:0,columnIndex:0}}}]})});console.log("Raportti-välilehti luotu ja kaavat syötetty.")}document.querySelector(".menu-toggle").onclick=()=>{document.querySelector(".nav-links").classList.toggle("open")},window.onload=()=>{tokenClient=google.accounts.oauth2.initTokenClient({client_id:CLIENT_ID,scope:SCOPES,callback:async e=>{if(document.getElementById("login-btn").style.display="none",showLoader(),!e.access_token)return hideLoader(),void(document.getElementById("login-btn").style.display="inline");accessToken=e.access_token,await findOrCreateSheet(),document.getElementById("log-form").style.display="block",document.getElementById("load-entries").style.display="inline",document.getElementById("export-pdf").style.display="inline",document.getElementById("export-pistol-report").style.display="inline",document.getElementById("report-dropdown").style.display="block",document.getElementById("login").innerHTML="<p>Olet kirjautunut sisään</p>",populateDatalist("weapons","weapons"),populateDatalist("locations","locations"),populateDatalist("calibers","calibers"),hideLoader()}}),document.getElementById("login-btn").onclick=()=>{tokenClient.requestAccessToken()},document.getElementById("log-form").addEventListener("submit",(async e=>{showLoader(),e.preventDefault();const t=document.getElementById("date").value,a=[{userEnteredValue:{numberValue:(new Date(t)-new Date("1899-12-30"))/864e5},userEnteredFormat:{numberFormat:{type:"DATE",pattern:"yyyy-mm-dd"}}},{userEnteredValue:{stringValue:document.getElementById("event").value}},{userEnteredValue:{stringValue:document.getElementById("type").value}},{userEnteredValue:{stringValue:document.getElementById("caliber").value}},{userEnteredValue:{stringValue:document.getElementById("weapon").value}},{userEnteredValue:{stringValue:document.getElementById("tt").value}},{userEnteredValue:{stringValue:document.getElementById("location").value}},{userEnteredValue:{numberValue:Number(document.getElementById("rounds").value)}},{userEnteredValue:{stringValue:document.getElementById("notes").value}}];saveToLocalStorage("weapons",document.getElementById("weapon").value),saveToLocalStorage("locations",document.getElementById("location").value),saveToLocalStorage("calibers",document.getElementById("caliber").value);const n=await getSheetIdByTitle(SHEET_TAB);if(!n)return document.getElementById("status").textContent="Taulukkoa ei löytynyt.",void hideLoader();let s;if(editingRow)s=editingRow,editingRow=null;else{const e=await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${SHEET_TAB}!A:A`,{headers:{Authorization:"Bearer "+accessToken}}),t=await e.json();s=t.values?.length||1}await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}:batchUpdate`,{method:"POST",headers:{Authorization:"Bearer "+accessToken,"Content-Type":"application/json"},body:JSON.stringify({requests:[{updateCells:{start:{sheetId:n,rowIndex:s,columnIndex:0},rows:[{values:a}],fields:"*"}}]})}),hideLoader(),showConfirmation(a.map((e=>e.userEnteredValue?.stringValue??e.userEnteredValue?.numberValue??""))),document.getElementById("log-form").reset(),document.getElementById("status").textContent="Merkintä tallennettu."})),window.loadEntries=async function(){document.getElementById("global-loader").style.display="flex";const e=await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${SHEET_TAB}`,{headers:{Authorization:"Bearer "+accessToken}}),t=(await e.json()).values.slice(1),a=t.length;t.reverse();const n=document.getElementById("entry-cards");n.innerHTML="",t.forEach(((e,t)=>{const s=a-t,o=document.createElement("div");o.className="entry-card";const r=document.createElement("h3");r.textContent=`${e[0]||""} – ${e[1]||""}`,o.appendChild(r);const l=document.createElement("p");l.textContent=`Ase: ${e[2]||""} (${e[3]||""})`,o.appendChild(l);const i=document.createElement("p");i.textContent=`Paikka: ${e[4]||""}`,o.appendChild(i);const d=document.createElement("p");d.textContent=`Laukaukset: ${e[5]||""}`,o.appendChild(d);const c=document.createElement("p"),u=document.createElement("strong");u.textContent="Kuvaus:",c.appendChild(u),c.appendChild(document.createElement("br")),c.appendChild(document.createTextNode(e[6]||"")),o.appendChild(c);const p=document.createElement("div");p.className="actions";const m=document.createElement("button");m.className="edit",m.textContent="Muokkaa",m.onclick=()=>editRow(s),p.appendChild(m);const h=document.createElement("button");h.className="delete",h.textContent="Poista",h.onclick=()=>deleteRow(s,o),p.appendChild(h),o.appendChild(p),n.appendChild(o)})),document.getElementById("global-loader").style.display="none"},document.getElementById("load-entries").onclick=loadEntries},window.editRow=async e=>{const t=await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${SHEET_TAB}!A${e+1}:I${e+1}`,{headers:{Authorization:"Bearer "+accessToken}}),a=await t.json(),n=a.values?.[0]||[];document.getElementById("log-form").style.display="block",["date","event","type","caliber","weapon","tt","location","rounds","notes"].forEach(((e,t)=>{const a=document.getElementById(e);let s=void 0!==n[t]?n[t]:"";"date"===e&&s.includes("/")&&(s=s.split("/").reverse().join("-")),a.value=s})),editingRow=e,document.getElementById("status").textContent=`Muokataan riviä ${e}`,setTimeout((()=>window.scrollTo(0,0)),50)},window.deleteRow=async function(e,t){const a=await getSheetIdByTitle(SHEET_TAB);if(!a)return void(document.getElementById("status").textContent="Taulukkoa ei löytynyt.");t.style.opacity="0.5",t.querySelector(".actions").innerHTML="<em>Poistetaan...</em>";const n={requests:[{deleteDimension:{range:{sheetId:a,dimension:"ROWS",startIndex:e,endIndex:e+1}}}]};await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}:batchUpdate`,{method:"POST",headers:{Authorization:"Bearer "+accessToken,"Content-Type":"application/json"},body:JSON.stringify(n)}),t.remove(),document.getElementById("status").textContent="Rivi poistettu."},document.getElementById("export-pdf").onclick=async()=>{const e=await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${SHEET_TAB}`,{headers:{Authorization:"Bearer "+accessToken}}),t=(await e.json()).values,{jsPDF:a}=window.jspdf,n=new a;let s=20;n.setFontSize(16),n.text("Ampumapäiväkirja",10,15),n.setFontSize(10);for(let e=1;e<t.length;e++){const[a,o,r,l,i,d,c,u,p=""]=t[e],m=[`${a} — ${o}`,`${i} (${d}) @ ${c} | ${u} laukausta`,`Huomiot: ${p||"-"}`];for(let e of m){const t=n.splitTextToSize(e,180);n.text(t,10,s),s+=5.5*t.length}s+=5,s>270&&(n.addPage(),s=20)}n.save("ampumapaivakirja.pdf")},document.getElementById("generate-report").onclick=async()=>{const e=document.getElementById("report-select").value;"pistol-2v"===e?await exportPistolReport():await generateGeneralReport(e)},document.getElementById("export-pistol-report").onclick=async()=>{const e=await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${SHEET_TAB}`,{headers:{Authorization:"Bearer "+accessToken}}),t=(await e.json()).values,a=new Date,n=new Date;n.setFullYear(a.getFullYear()-2);const{jsPDF:s}=window.jspdf,o=new s;let r=20;const l=e=>e.toISOString().split("T")[0];o.setFontSize(16),o.text("Pistooliraportti – 2v",10,15),o.setFontSize(10),o.text(`Ajanjakso: ${l(n)} – ${l(a)}`,10,r),r+=7;let i=t.slice(1).filter((e=>{const t=new Date(e[0]);return!isNaN(t)&&t>=n&&"pistooli"===e[2]?.toLowerCase()})),d=0;i.forEach((e=>{const t=parseInt(e[7])||0;d+=t})),o.text(`Käyntejä: ${i.length}`,10,r),r+=5,o.text(`Laukauksia yhteensä: ${d}`,10,r),r+=10,i.forEach((e=>{const[t,a,n,s,l,i,d,c,u=""]=e,p=[`${t} — ${a}`,`${l} (${i}) @ ${d} | ${c} laukausta`,`Huomiot: ${u||"-"}`];for(let e of p){const t=o.splitTextToSize(e,180);o.text(t,10,r),r+=5.5*t.length}r+=5,r>270&&(o.addPage(),r=20)})),o.save("pistooliraportti_2v.pdf")};let lastScrollY=window.scrollY;const header=document.querySelector(".site-header"),nav=document.querySelector(".nav-links");async function generateGeneralReport(e){const t=await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${SHEET_TAB}`,{headers:{Authorization:"Bearer "+accessToken}}),a=(await t.json()).values.slice(1),n=new Date,s=new Date;s.setFullYear(n.getFullYear()-1);const{jsPDF:o}=window.jspdf,r=new o;let l=20;r.setFontSize(16),r.text("Yleinen raportti – 1v",10,15),r.setFontSize(10),r.text(`Ajanjakso: ${s.toISOString().split("T")[0]} – ${n.toISOString().split("T")[0]}`,10,l),l+=7;let i=a.filter((e=>{const t=new Date(e[0]);return!isNaN(t)&&t>=s})),d=0;i.forEach((e=>{const t=parseInt(e[7])||0;d+=t})),r.text(`Käyntejä: ${i.length}`,10,l),l+=5,r.text(`Laukauksia yhteensä: ${d}`,10,l),l+=10,i.forEach((e=>{const[t,a,n,s,o,i,d,c,u=""]=e,p=[`${t} — ${a}`,`${o} (${i}) @ ${d} | ${c} laukausta`,`Huomiot: ${u||"-"}`];for(let e of p){const t=r.splitTextToSize(e,180);r.text(t,10,l),l+=5.5*t.length}l+=5,l>270&&(r.addPage(),l=20)})),r.save("yleinen_raportti_1v.pdf")}window.addEventListener("scroll",(()=>{const e=window.scrollY;nav.classList.contains("open")&&nav.classList.remove("open"),e>lastScrollY&&e>100?(header.classList.remove("nav-shown"),header.classList.add("nav-hidden")):(header.classList.remove("nav-hidden"),header.classList.add("nav-shown")),lastScrollY=e})),document.addEventListener("DOMContentLoaded",(()=>{document.querySelector(".site-header").classList.add("nav-shown")}));